<!DOCTYPE html>
<html>
  <head>
    <title>Line Chart</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.3.1/js/bootstrap.min.js"></script>
    <!--suppress JSUnresolvedLibraryURL -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"></script>
    <script src="{{url_for('static', filename='js/utils.js')}}"></script>
    <style>
      canvas {
        -moz-user-select: none;
        -webkit-user-select: none;
        -ms-user-select: none;
      }
    </style>
  </head>

  <body>
    <div style="width: 1000px;">
      <p>
        This example demonstrates a time series scale by drawing a financial
        line chart using just the core library. For more specific functionality
        for financial charts, please see
        <a href="https://github.com/chartjs/chartjs-chart-financial"
          >chartjs-chart-financial</a
        >
      </p>
      <canvas id="chart1"></canvas>
    </div>
    <br />
    <br />
    Chart Type:
    <select id="type">
      <option value="line">Line</option>
      <option value="bar">Bar</option>
    </select>
    <select id="unit">
      <option value="second">Second</option>
      <option value="minute">Minute</option>
      <option value="hour">Hour</option>
      <option value="day" selected>Day</option>
      <option value="month">Month</option>
      <option value="year">Year</option>
    </select>
    <button id="update">update</button>
    <script>
      function generateData() {
        var unit = document.getElementById("unit").value;

        function unitLessThanDay() {
          return unit === "second" || unit === "minute" || unit === "hour";
        }

        function beforeNineThirty(date) {
          return date.hour() < 9 || (date.hour() === 9 && date.minute() < 30);
        }

        // Returns true if outside 9:30am-4pm on a weekday
        function outsideMarketHours(date) {
          if (date.isoWeekday() > 5) {
            return true;
          }
          if (
            unitLessThanDay() &&
            (beforeNineThirty(date) || date.hour() > 16)
          ) {
            return true;
          }
          return false;
        }

        function randomNumber(min, max) {
          return Math.random() * (max - min) + min;
        }

        function randomBar(date, lastClose) {
          var open = randomNumber(lastClose * 0.95, lastClose * 1.05).toFixed(
            2
          );
          var close = randomNumber(open * 0.95, open * 1.05).toFixed(2);
          return {
            t: date.valueOf(),
            y: close,
          };
        }

        var date = moment("Jan 01 1999", "MMM DD YYYY");
        console.log(date.valueOf());
        var now = moment();
        var data = [];
        var lessThanDay = unitLessThanDay();
        for (
          ;
          data.length < 600 && date.isBefore(now);
          date = date.clone().add(1, unit).startOf(unit)
        ) {
          if (outsideMarketHours(date)) {
            if (!lessThanDay || !beforeNineThirty(date)) {
              date = date
                .clone()
                .add(date.isoWeekday() >= 5 ? 8 - date.isoWeekday() : 1, "day");
            }
            if (lessThanDay) {
              date = date.hour(9).minute(30).second(0);
            }
          }
          data.push(
            randomBar(date, data.length > 0 ? data[data.length - 1].y : 30)
          );
        }

        console.log(data);
        data = [
          { t: 1585946687000.0, y: "10.816881202216347" },
          { t: 1585946725000.0, y: "13.254499871664526" },
          { t: 1585946733000.0, y: "7.383425190476549" },
          { t: 1585947347000.0, y: "8.134647638389655" },
          { t: 1585947392000.0, y: "4.851484248632401" },
          { t: 1585947524000.0, y: "15.581242046872228" },
          { t: 1585947541000.0, y: "5.264664392674887" },
          { t: 1585947557000.0, y: "0.479652297281159" },
          { t: 1585948783000.0, y: "2.7644467331696365" },
          { t: 1585949052000.0, y: "6.801217206074672" },
          { t: 1585949307000.0, y: "10.862179465969106" },
          { t: 1585949658000.0, y: "11.3642246192382" },
          { t: 1585949660000.0, y: "2.518765185010534" },
          { t: 1585949663000.0, y: "7.692671090621658" },
          { t: 1585949665000.0, y: "16.78248769567717" },
          { t: 1585949668000.0, y: "10.633185424366747" },
          { t: 1585949671000.0, y: "6.350526217179134" },
          { t: 1585949673000.0, y: "7.63774053835008" },
          { t: 1585949676000.0, y: "6.942283176363436" },
          { t: 1585949679000.0, y: "1.056758957204016" },
          { t: 1585949681000.0, y: "13.77707231623236" },
          { t: 1585949687000.0, y: "16.948706421774588" },
          { t: 1585949691000.0, y: "16.979431064705494" },
          { t: 1585949695000.0, y: "9.190378286091272" },
          { t: 1585955463000.0, y: "4.3509325212203525" },
          { t: 1585955467000.0, y: "10.919582431059673" },
          { t: 1585955470000.0, y: "17.55216341185215" },
          { t: 1585955474000.0, y: "7.124274210976478" },
          { t: 1585955477000.0, y: "12.502693436783678" },
          { t: 1585955481000.0, y: "18.35943504090189" },
          { t: 1585955484000.0, y: "6.092748622917328" },
          { t: 1585955490000.0, y: "3.4216021031177335" },
          { t: 1585955494000.0, y: "3.441087534360696" },
          { t: 1585955498000.0, y: "1.0323709867656716" },
          { t: 1585955501000.0, y: "10.12886375420555" },
          { t: 1585955505000.0, y: "11.404846533035498" },
          { t: 1585955508000.0, y: "1.5835393401760833" },
          { t: 1585955512000.0, y: "0.5048224376869848" },
          { t: 1585955515000.0, y: "18.63395377225823" },
          { t: 1585955519000.0, y: "15.805380869616343" },
          { t: 1585955522000.0, y: "2.6988018229802546" },
          { t: 1585955526000.0, y: "7.269554577661483" },
          { t: 1585955529000.0, y: "9.734003093048356" },
          { t: 1585962461000.0, y: "12.899292363930083" },
          { t: 1585971852000.0, y: "1.860459577097695" },
          { t: 1586565907000.0, y: "0.26567927888293763" },
          { t: 1586565908000.0, y: "8.474088574159353" },
          { t: 1586565923000.0, y: "16.390781540637278" },
          { t: 1586565938000.0, y: "9.718200950336556" },
          { t: 1586565954000.0, y: "0.5521962558010118" },
          { t: 1586565969000.0, y: "8.984414857563937" },
          { t: 1586565985000.0, y: "15.90930269461802" },
          { t: 1586566000000.0, y: "0.4001877141248067" },
          { t: 1586655106000.0, y: "19.310388552340896" },
          { t: 1586655112000.0, y: "0.30989922815013227" },
          { t: 1586655117000.0, y: "13.737753545675593" },
          { t: 1586655123000.0, y: "14.086110035314395" },
          { t: 1586655128000.0, y: "15.844421771082363" },
          { t: 1586655134000.0, y: "16.27088218035867" },
          { t: 1586655140000.0, y: "9.342592784966964" },
          { t: 1586655145000.0, y: "8.875567015654315" },
          { t: 1586655151000.0, y: "13.329204840996931" },
          { t: 1586655156000.0, y: "7.238557882360556" },
          { t: 1586655162000.0, y: "13.732978407793354" },
          { t: 1586655167000.0, y: "14.526139016161776" },
          { t: 1586655173000.0, y: "12.733105692313893" },
          { t: 1586655179000.0, y: "16.064946702072866" },
          { t: 1586655184000.0, y: "5.767247850048696" },
          { t: 1586655190000.0, y: "4.534155227354364" },
          { t: 1586655195000.0, y: "16.814229231719644" },
          { t: 1586655201000.0, y: "4.306926085243696" },
          { t: 1586655206000.0, y: "18.527933568320755" },
          { t: 1586655212000.0, y: "5.40034353718124" },
          { t: 1586655217000.0, y: "3.9832100067594767" },
          { t: 1586655223000.0, y: "15.529533902346346" },
          { t: 1586655228000.0, y: "1.941763263945262" },
          { t: 1586655233000.0, y: "19.9682731055561" },
          { t: 1586655239000.0, y: "6.043411733442694" },
          { t: 1586655244000.0, y: "12.907265049903593" },
          { t: 1586655250000.0, y: "15.542333876436956" },
          { t: 1586655255000.0, y: "17.622505030796468" },
          { t: 1586655260000.0, y: "18.06612246935578" },
          { t: 1586655266000.0, y: "9.47354596145827" },
          { t: 1586655271000.0, y: "0.8508414389636387" },
          { t: 1586655277000.0, y: "15.588051836241712" },
          { t: 1586655283000.0, y: "4.991737919568018" },
          { t: 1586655288000.0, y: "0.10396328284708822" },
          { t: 1586655293000.0, y: "8.704054128940674" },
          { t: 1586655299000.0, y: "18.347487705016547" },
          { t: 1586655304000.0, y: "18.11183368581592" },
          { t: 1586655310000.0, y: "5.81843061748216" },
          { t: 1586655315000.0, y: "12.683717948689955" },
          { t: 1586655320000.0, y: "6.76400027140401" },
          { t: 1586655326000.0, y: "10.13936319084398" },
          { t: 1586655331000.0, y: "8.352874192689416" },
          { t: 1586655337000.0, y: "12.123825613961847" },
          { t: 1586655342000.0, y: "9.328733893750044" },
          { t: 1586655347000.0, y: "2.1900047685103874" },
          { t: 1586655353000.0, y: "7.056466916105637" },
          { t: 1586655358000.0, y: "8.385167213112585" },
          { t: 1586655363000.0, y: "16.96788153830871" },
          { t: 1586655369000.0, y: "15.419690168833927" },
          { t: 1586655374000.0, y: "7.909417361031137" },
          { t: 1586655381000.0, y: "13.641725659982196" },
          { t: 1586655386000.0, y: "0.43594105797043037" },
          { t: 1586655392000.0, y: "10.453515953765667" },
          { t: 1586655397000.0, y: "9.340577481733948" },
          { t: 1586655403000.0, y: "13.81010500351221" },
          { t: 1586655408000.0, y: "2.4226015311605043" },
          { t: 1586655413000.0, y: "10.185206962653288" },
          { t: 1586655419000.0, y: "13.786961279399907" },
          { t: 1586655424000.0, y: "18.814133072099825" },
          { t: 1586655430000.0, y: "14.39425056934855" },
          { t: 1586655435000.0, y: "4.261422979089684" },
          { t: 1586655440000.0, y: "9.006859270547887" },
          { t: 1586655446000.0, y: "3.2059915257672023" },
          { t: 1586655451000.0, y: "8.640344085192208" },
          { t: 1586655457000.0, y: "2.5338108982451013" },
          { t: 1586655462000.0, y: "13.392699842491751" },
          { t: 1586655467000.0, y: "12.803883116782542" },
          { t: 1586655473000.0, y: "17.952406404365007" },
          { t: 1586655478000.0, y: "5.448641149580496" },
          { t: 1586655484000.0, y: "1.1044055506935369" },
          { t: 1586655489000.0, y: "10.22424851045654" },
          { t: 1586655494000.0, y: "18.684432271713856" },
          { t: 1586655500000.0, y: "0.5978493823677211" },
          { t: 1586655505000.0, y: "19.348744042202487" },
          { t: 1586655511000.0, y: "16.18594926684983" },
          { t: 1586655516000.0, y: "10.840518281142128" },
          { t: 1586655521000.0, y: "9.717267556887073" },
          { t: 1586655527000.0, y: "6.271716808796377" },
          { t: 1586655532000.0, y: "5.024359878501786" },
          { t: 1586655538000.0, y: "4.304460428083461" },
          { t: 1586655543000.0, y: "18.760748128984716" },
          { t: 1586655549000.0, y: "4.760898809588568" },
          { t: 1586655554000.0, y: "19.59526503400697" },
          { t: 1586655559000.0, y: "5.473582751228381" },
          { t: 1586655565000.0, y: "5.237263525569642" },
          { t: 1586655570000.0, y: "3.6310891980100557" },
          { t: 1586655576000.0, y: "13.99357155995336" },
          { t: 1586655581000.0, y: "1.689208556936559" },
          { t: 1586655587000.0, y: "8.731900547408726" },
          { t: 1586655592000.0, y: "14.792450652761922" },
          { t: 1586655597000.0, y: "8.991136586555315" },
          { t: 1586655603000.0, y: "11.182513817729312" },
          { t: 1586655608000.0, y: "10.258974772738547" },
          { t: 1586655614000.0, y: "14.08478726571148" },
          { t: 1586655619000.0, y: "10.065070693197294" },
          { t: 1586655624000.0, y: "15.863636001556321" },
          { t: 1586655630000.0, y: "0.5493545111144327" },
          { t: 1586655635000.0, y: "10.268760807177484" },
          { t: 1586655640000.0, y: "4.66602240526637" },
          { t: 1586655646000.0, y: "13.0514876715199" },
          { t: 1586655651000.0, y: "15.493329749440994" },
          { t: 1586655657000.0, y: "17.22097232896793" },
          { t: 1586655662000.0, y: "4.552095412307098" },
          { t: 1586655668000.0, y: "1.5649214649601562" },
          { t: 1586655673000.0, y: "3.2451667185304722" },
          { t: 1586655678000.0, y: "12.715192194473683" },
          { t: 1586655684000.0, y: "15.120981898153346" },
          { t: 1586655689000.0, y: "6.11701416860871" },
          { t: 1586655695000.0, y: "14.150580079041529" },
          { t: 1586655700000.0, y: "2.5406395942056403" },
          { t: 1586655705000.0, y: "9.19803480162178" },
          { t: 1586655711000.0, y: "2.08891606153786" },
          { t: 1586655716000.0, y: "9.928849172238705" },
          { t: 1586655722000.0, y: "15.166571157094445" },
          { t: 1586655727000.0, y: "13.719643152957936" },
          { t: 1586655733000.0, y: "1.7835295552756936" },
          { t: 1586655738000.0, y: "17.06545065597456" },
          { t: 1586655743000.0, y: "17.547082074936405" },
          { t: 1586655749000.0, y: "5.150798016954974" },
          { t: 1586655754000.0, y: "3.468996119066403" },
          { t: 1586655760000.0, y: "1.0249196314521036" },
          { t: 1586655765000.0, y: "19.114014941067957" },
          { t: 1586655770000.0, y: "0.08124324569396713" },
          { t: 1586655776000.0, y: "1.8256762165355012" },
          { t: 1586655781000.0, y: "3.373901934840331" },
          { t: 1586655787000.0, y: "13.2344667102692" },
          { t: 1586655792000.0, y: "8.436251806336724" },
          { t: 1586655797000.0, y: "5.180650799583633" },
          { t: 1586655803000.0, y: "10.724938217600176" },
          { t: 1586655808000.0, y: "6.9543814282440515" },
          { t: 1586655814000.0, y: "17.717331924637847" },
          { t: 1586655819000.0, y: "13.272709117716987" },
          { t: 1586655825000.0, y: "0.08091364530719236" },
          { t: 1586655830000.0, y: "19.38709947885939" },
          { t: 1586655835000.0, y: "15.72045054845261" },
          { t: 1586655841000.0, y: "7.5084106774760695" },
          { t: 1586655846000.0, y: "11.626816117909232" },
          { t: 1586655852000.0, y: "2.830194813504052" },
          { t: 1586655857000.0, y: "16.879926596875645" },
          { t: 1586655862000.0, y: "2.3093878056724004" },
          { t: 1586655868000.0, y: "4.282822339530941" },
          { t: 1586655873000.0, y: "8.590911391066298" },
          { t: 1586655879000.0, y: "18.45681894387901" },
          { t: 1586655884000.0, y: "17.784816181281293" },
          { t: 1586655889000.0, y: "4.703817992541158" },
          { t: 1586655895000.0, y: "15.374024455220122" },
          { t: 1586655900000.0, y: "3.3655377354424565" },
          { t: 1586655906000.0, y: "17.192977095390752" },
          { t: 1586655911000.0, y: "5.360864073140252" },
          { t: 1586655916000.0, y: "10.663165217212917" },
          { t: 1586655922000.0, y: "10.028698140478342" },
          { t: 1586655928000.0, y: "1.8439889443895119" },
          { t: 1586655933000.0, y: "12.201770074813972" },
          { t: 1586655938000.0, y: "9.342411559006589" },
          { t: 1586655944000.0, y: "14.906791064016343" },
          { t: 1586655949000.0, y: "18.164743512178006" },
          { t: 1586655955000.0, y: "6.925455124879358" },
          { t: 1586655960000.0, y: "13.487042408922868" },
          { t: 1586655966000.0, y: "7.075441731485002" },
          { t: 1586655971000.0, y: "3.351116337373683" },
          { t: 1586655977000.0, y: "5.871192272255737" },
          { t: 1586655983000.0, y: "11.832187842230784" },
          { t: 1586655988000.0, y: "3.971140164549576" },
          { t: 1586655994000.0, y: "14.39494519359011" },
          { t: 1586655999000.0, y: "15.710538288211811" },
          { t: 1586656005000.0, y: "8.608796725383081" },
          { t: 1586656010000.0, y: "1.6582581821632614" },
          { t: 1586656015000.0, y: "3.055321489695215" },
          { t: 1586656021000.0, y: "19.27439251296975" },
          { t: 1586656026000.0, y: "6.380876313850823" },
          { t: 1586656032000.0, y: "14.63153674190179" },
          { t: 1586656037000.0, y: "9.379150998646505" },
          { t: 1586656042000.0, y: "10.454524944809297" },
          { t: 1586656048000.0, y: "16.589608464321984" },
          { t: 1586656053000.0, y: "14.639616081813875" },
          { t: 1586656062000.0, y: "15.845286184268462" },
          { t: 1586656068000.0, y: "16.98015105400888" },
          { t: 1586656072000.0, y: "10.060509104571807" },
          { t: 1586656073000.0, y: "19.787382915641032" },
          { t: 1586656078000.0, y: "17.935515084995274" },
          { t: 1586656079000.0, y: "11.070691956009536" },
          { t: 1586656083000.0, y: "2.169041592703256" },
          { t: 1586656084000.0, y: "5.350566415716111" },
          { t: 1586656086000.0, y: "14.032705568739928" },
          { t: 1586656089000.0, y: "13.839079668528868" },
          { t: 1586656090000.0, y: "15.759820522528532" },
          { t: 1586656091000.0, y: "19.781726348811077" },
          { t: 1586656094000.0, y: "11.470498635462512" },
          { t: 1586656095000.0, y: "1.4625031309387615" },
          { t: 1586656096000.0, y: "5.425041430551055" },
          { t: 1586656099000.0, y: "0.8155380737337459" },
          { t: 1586656100000.0, y: "19.11708272675675" },
          { t: 1586656102000.0, y: "11.626738853086373" },
          { t: 1586656105000.0, y: "4.255581187421678" },
          { t: 1586656106000.0, y: "16.66934957373792" },
          { t: 1586656107000.0, y: "8.600978078870178" },
          { t: 1586656110000.0, y: "1.910253205781225" },
          { t: 1586656111000.0, y: "5.455815737448518" },
          { t: 1586656112000.0, y: "3.5402817602366277" },
          { t: 1586656115000.0, y: "9.251383596009614" },
          { t: 1586656116000.0, y: "15.795959103207819" },
          { t: 1586656117000.0, y: "10.650329921219333" },
          { t: 1586656118000.0, y: "17.32697340773373" },
          { t: 1586656120000.0, y: "17.059122086054202" },
          { t: 1586656121000.0, y: "5.105139000029797" },
          { t: 1586656122000.0, y: "17.853841538995205" },
          { t: 1586656123000.0, y: "9.432080882082714" },
          { t: 1586656123000.0, y: "17.449400052876115" },
          { t: 1586656125000.0, y: "6.267782509935989" },
          { t: 1586656126000.0, y: "17.199640103247965" },
          { t: 1586656127000.0, y: "8.302531097477562" },
          { t: 1586656128000.0, y: "7.383923574491011" },
          { t: 1586656129000.0, y: "13.49901853809732" },
          { t: 1586656130000.0, y: "17.496164413522404" },
          { t: 1586656132000.0, y: "16.27087793513687" },
          { t: 1586656133000.0, y: "16.250378149215475" },
          { t: 1586656133000.0, y: "10.468457759707954" },
          { t: 1586656134000.0, y: "5.466456323917366" },
          { t: 1586656136000.0, y: "0.03842391243699117" },
        ];

        return data;
      }

      var ctx = document.getElementById("chart1").getContext("2d");
      ctx.canvas.width = 1000;
      ctx.canvas.height = 300;

      var color = Chart.helpers.color;
      var cfg = {
        data: {
          datasets: [
            {
              label: "CHRT - Chart.js Corporation",
              backgroundColor: color(window.chartColors.red)
                .alpha(0.5)
                .rgbString(),
              borderColor: window.chartColors.red,
              data: generateData(),
              type: "line",
              pointRadius: 0,
              fill: false,
              lineTension: 0,
              borderWidth: 2,
            },
          ],
        },
        options: {
          animation: {
            duration: 0,
          },
          scales: {
            xAxes: [
              {
                type: "time",
                // time: {
                //   unit: "minute",
                // },
                distribution: "series",
                offset: true,
                ticks: {
                  major: {
                    enabled: true,
                    fontStyle: "bold",
                  },
                  source: "data",
                  autoSkip: true,
                  autoSkipPadding: 75,
                  maxRotation: 0,
                  sampleSize: 100,
                },
                // afterBuildTicks: function (scale, ticks) {
                //   var majorUnit = scale._majorUnit;
                //   var firstTick = ticks[0];
                //   var i, ilen, val, tick, currMajor, lastMajor;

                //   val = moment(ticks[0].value);
                //   if (
                //     (majorUnit === "minute" && val.second() === 0) ||
                //     (majorUnit === "hour" && val.minute() === 0) ||
                //     (majorUnit === "day" && val.hour() === 9) ||
                //     (majorUnit === "month" &&
                //       val.date() <= 3 &&
                //       val.isoWeekday() === 1) ||
                //     (majorUnit === "year" && val.month() === 0)
                //   ) {
                //     firstTick.major = true;
                //   } else {
                //     firstTick.major = false;
                //   }
                //   lastMajor = val.get(majorUnit);

                //   for (i = 1, ilen = ticks.length; i < ilen; i++) {
                //     tick = ticks[i];
                //     val = moment(tick.value);
                //     currMajor = val.get(majorUnit);
                //     tick.major = currMajor !== lastMajor;
                //     lastMajor = currMajor;
                //   }
                //   return ticks;
                // },
              },
            ],
            yAxes: [
              {
                gridLines: {
                  drawBorder: false,
                },
                scaleLabel: {
                  display: true,
                  labelString: "Closing price ($)",
                },
              },
            ],
          },
          tooltips: {
            intersect: false,
            mode: "index",
            callbacks: {
              label: function (tooltipItem, myData) {
                var label =
                  myData.datasets[tooltipItem.datasetIndex].label || "";
                if (label) {
                  label += ": ";
                }
                label += parseFloat(tooltipItem.value).toFixed(2);
                return label;
              },
            },
          },
        },
      };

      var chart = new Chart(ctx, cfg);

      document.getElementById("update").addEventListener("click", function () {
        var type = document.getElementById("type").value;
        var dataset = chart.config.data.datasets[0];
        dataset.type = type;
        dataset.data = generateData();
        console.log(dataset.data);
        chart.update();
      });
    </script>
  </body>
</html>
